<!DOCTYPE html>
<html lang="en-US" class="">

<!-- Mirrored from 127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 22 Sep 2025 18:52:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <!-- Basics -->
    <title>Adding A Custom Builtins Extension - Guides - oneAPI Construction Kit - Products - Codeplay Developer</title>
    <meta name="description" content="Read the 'Adding A Custom Builtins Extension' for oneAPI Construction Kit 4.0.0 developer guide." />
    <meta name="keywords" content="guides, tutorials, guide, oneapi, construction, kit, risc-v, arm" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Open Graph -->
    <meta name="title" property="og:title" content="Adding A Custom Builtins Extension - Guides - oneAPI Construction Kit - Products - Codeplay Developer" />
    <meta name="type" property="og:type" content="website" />
    <meta name="image" property="og:image" content="http://127.0.0.1/assets/img/og-header.png" />
    <meta name="url" property="og:url" content="http://127.0.0.1/" />
    <meta name="description" property="og:description" content="Read the 'Adding A Custom Builtins Extension' for oneAPI Construction Kit 4.0.0 developer guide." />

    <!-- Fonts -->
    <link href="http://127.0.0.1/assets/css/material.css"
          rel="stylesheet preload prefetch"
          as="style" />

    <!-- Fav icon -->
    <link rel="icon" type="image/png" href="http://127.0.0.1/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="http://127.0.0.1/favicon.svg" />
    <link rel="shortcut icon" href="http://127.0.0.1/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="http://127.0.0.1/apple-touch-icon.png" />

    <link type="text/css"
          href="http://127.0.0.1/assets/css/responsive.css"
          rel="stylesheet"/>

    <script src="https://cdn.usefathom.com/script.js" data-site="XBWVDDFP" defer></script>

    <!-- Stylesheets -->
    <link type="text/css"
          href="http://127.0.0.1/assets/css/jquery.cookiepolicyprompt.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/jquery.popupdialog.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/dialogs.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/IndexPage.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Guides/GuidePageLayout.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Guides/GuidePageFormatting.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Guides/GuidePage.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Products/OneApi/ConstructionKit/OneApiConstructionKitShared.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Products/OneApi/ConstructionKit/Guide/OneApiConstructionKitGuidePage.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>
    <link type="text/css"
          href="http://127.0.0.1/assets/css/Pages/Products/OneApi/ConstructionKit/Guide/OneApiConstructionKitGuidePage.style.css"
          rel="stylesheet preload prefetch"
          as="style"/>

    <!-- Scripts -->
    <script src="http://127.0.0.1/assets/js/jquery-3.6.3.min.js"></script>
    <script src="http://127.0.0.1/assets/js/jquery.copyright.js"></script>
    <script src="http://127.0.0.1/assets/js/jquery.cookiepolicyprompt.js"></script>
    <script src="http://127.0.0.1/assets/js/jquery.popupdialog.js"></script>
    <script src="http://127.0.0.1/assets/js/Pages/IndexPage.script.js"></script>
    <script src="http://127.0.0.1/assets/js/highlight.min.js"></script>
    <script src="http://127.0.0.1/assets/js/Pages/Guides/jquery.headingsinfocus.js"></script>
    <script src="http://127.0.0.1/assets/js/Pages/Guides/togglebutton.js"></script>
    <script src="http://127.0.0.1/assets/js/Pages/Guides/jquery.resizable.js"></script>
    <script src="http://127.0.0.1/assets/js/Pages/Guides/GuidePage.script.js"></script>

    <script>
        document.querySelectorAll('link').forEach((el) => {this.onload=null;this.rel='stylesheet';});
    </script>
</head>
<body data-deprecated="">

<!-- Header -->
<header>
    <nav class="main">
        <div>
            <a aria-label="Navigation Bar Logo" href="http://127.0.0.1/">
                <div id="codeplay-logo"></div>
            </a>
        </div>
        <div>
            <a title="Click to change production selection">
                <div>
                    <h2>Product</h2>
                    <h1>oneAPI Construction Kit</h1>
                </div>
            </a>
        </div>
        <div>
            <ul>
                <li >
                    <a href="http://127.0.0.1/products/oneapi/construction-kit/home" >
                        <div>

                            <span class="icon material-icons">home</span>

                            <div>Home</div>
                        </div>
                    </a>
                </li>
                <li  class="selected" >
                    <a href="http://127.0.0.1/products/oneapi/construction-kit/guides/" >
                        <div>

                            <span class="icon material-icons">menu_book</span>

                            <div>Guides</div>
                        </div>
                    </a>
                </li>
                <li >
                    <a href="https://github.com/codeplaysoftware/oneapi-construction-kit" target="_blank">
                        <div>

                            <span class="icon material-icons">local_library</span>

                            <div>Repository</div>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
        <div>
            <ul>
                <li>
                    <a href="http://127.0.0.1/support/" title="Get Support">
                        <span class="material-icons">help_outline</span>
                    </a>
                </li>
                <li>
                    <a id="burger"
                       title="Show Navigation Menu">
                        <span class="material-icons">menu</span>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <!-- The burger menu, designed for mobile -->
    <div id="burger-menu">
        <ul>
            <li>
                <h1>oneAPI Menu</h1>
                <ul>
                    <li >
                        <a href="http://127.0.0.1/products/oneapi/construction-kit/home"
                           >Home</a>
                    </li>
                    <li  class="selected" >
                        <a href="http://127.0.0.1/products/oneapi/construction-kit/guides/"
                           >Guides</a>
                    </li>
                    <li >
                        <a href="https://github.com/codeplaysoftware/oneapi-construction-kit"
                           target="_blank">Repository</a>
                    </li>
                </ul>
            </li>
            <li>
                <h1>Main Menu</h1>
                <ul>
                    <li>
                        <a href="http://127.0.0.1/">Home</a>
                    </li>
                    <li>
                        <h1>Products</h1>
                        <ul>
                            <li>
                                <a href="http://127.0.0.1/products/computecpp/ce/">ComputeCpp CE</a>
                            </li>
                            <li>
                                <a href="http://127.0.0.1/products/computecpp/pe/">ComputeCpp PE</a>
                            </li>
                            <li>
                                <a href="http://127.0.0.1/products/computesuitercar/ce/">ComputeSuite for R-Car CE</a>
                            </li>
                            <li>
                                <a href="http://127.0.0.1/products/computesuitercar/pe/">ComputeSuite for R-Car PE</a>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <a href="http://127.0.0.1/cookies">Cookie Policy</a>
                    </li>
                    <li>
                        <a href="https://codeplay.com/support/contact">Contact Us</a>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</header>

<!-- Main element -->
<main>

    <!-- File Container -->
<div class="layout-file guide" id="tutorials-adding-a-custom-builtins-extension">
    <!-- Side Menu -->
    <div class="sticky file-menu-container styled-scroller">
       <div class="nav-padding">
           <!-- Title & Version Selector -->
           <div class="header">
               <h1 class="file-container-title">
                   <span class="material-icons">menu_book</span>Guides
               </h1>
               <div>
                   <!-- Version Selector -->
                   <div class="version-selector ">
                       <div><span class="material-icons">history</span>4.0.0</div>
                       <ul>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension">4.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/3.0.0/guides/tutorials/adding-a-custom-builtins-extension">3.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/2.0.0/guides/tutorials/adding-a-custom-builtins-extension">2.0.0</a></li>
                       </ul>
                       <ul>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension">4.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/3.0.0/guides/tutorials/adding-a-custom-builtins-extension">3.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/2.0.0/guides/tutorials/adding-a-custom-builtins-extension">2.0.0</a></li>
                       </ul>
                       <ul>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension">4.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/3.0.0/guides/tutorials/adding-a-custom-builtins-extension">3.0.0</a></li>
                           <li><a href="http://127.0.0.1/products/oneapi/construction-kit/2.0.0/guides/tutorials/adding-a-custom-builtins-extension">2.0.0</a></li>
                       </ul>
                   </div>
               </div>
           </div>
           <!-- Menu -->
           <ol class="file-menu">
               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/index.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Welcome to oneAPI Construction Kit’s documentation!</a><ol></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>oneAPI Construction Kit Overview</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/preface.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Preface</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/introduction.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Introduction</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/introduction/architecture.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>oneAPI Construction Kit Architecture</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/introduction/compiler-view.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Compiler View</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/hardware.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Mapping ComputeMux to Hardware</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/hardware/memory-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Memory Requirements</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/hardware/atomic-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Atomic Requirements</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/hardware/floating-point-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Floating-Point Requirements</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/hardware/synchronization-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Synchronization Requirements</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/runtime.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Runtime Information</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/runtime/computemux-runtime.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ComputeMux Runtime</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/runtime/driver-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Driver Requirements</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/runtime/supported-toolchains.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Supported Toolchains</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/compiler.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Compiler Information</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/compiler/computemux-compiler.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ComputeMux Compiler</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/compiler/ir.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Intermediate Representation</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/compiler/supported-llvm-versions.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Supported LLVM Versions</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/compiler/non-requirements.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ComputeMux Compiler Non-Requirements</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Example Hardware Feature Scenarios</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios/mapping-custom-instructions-to-builtin-functions.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Mapping Custom Instructions To Builtin Functions</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios/mapping-custom-ip-blocks-to-builtin-kernels.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Mapping Custom IP Blocks To Builtin Kernels</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios/how-to-support-large-scratchpad-memories.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>How To Support Large Scratchpad Memories</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios/mapping-algorithms-to-vector-hardware.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Mapping Algorithms To Vector Hardware</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/example-scenarios/refsi-in-kernel-dma.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>RefSi In-Kernel DMA for RISC-V</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/toolkit.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>oneAPI Construction Kit</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/new-target-quick-start.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Creating a New ComputeMux Target: Quick Start</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Tutorials</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-hal.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Creating a New HAL</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-new-hal/initial-setup.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Initial Setup</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-new-hal/kernel-compilation.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Kernel Compilation</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-new-hal/runing-clik-tests.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Running clik Tests</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-new-hal/skeleton-hal-overview.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Overview of the Skeleton HAL Code</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-new-hal/implementing-hal-operations.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Implementing HAL Operations</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Creating a New ComputeMux Target</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target/running-new-target-script.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Running the create_target.py Script</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target/building-and-running-tests.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Building and Running Tests</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target/adapting-target-pass-pipeline.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Adapting the Pass Pipeline for the Target</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target/extending-it-further.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Extending it Further</a><ol></ol></li></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Codeplay Reference Silicon</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/overview.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Codeplay Reference Silicon Overview</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/command-processor.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Command Processor Reference</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/dma-controller.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>DMA Controller Reference</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/dma-programming-guide.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>DMA Programming Guide</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/driver-interface.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>RefSi Driver Interface</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/reference-silicon/mapping-opencl-to-refsi.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>How The Platform Maps to SYCL and OpenCL</a><ol></ol></li></ol></li></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/getting-started.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Getting Started</a><ol></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/specifications.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Specifications</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/specifications/versioning.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Versioning Scheme</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/specifications/mux-runtime-spec.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ComputeMux Runtime Specification</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/specifications/mux-compiler-spec.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ComputeMux Compiler Specification</a><ol></ol></li></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/developer-guide.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Developer Guide</a><ol></ol></li>               <li class="selected"><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Tutorials</a><ol><li class="selected focused"><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Adding A Custom Builtins Extension</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/custom-lowering-work-item-builtins.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Custom Lowering Work-Item Builtins</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-target-specific-metadata.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Adding Target-Specific Metadata</a><ol></ol></li></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/design.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Design</a><ol></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>OpenCL</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/cmake.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>OpenCL CMake</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/computemux_mapping.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>How OpenCL Concepts Are Mapped Onto ComputeMux</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>OpenCL Extensions</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_kernel_debug.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Kernel Debug - cl_codeplay_kernel_debug</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_extra_build_options.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Extra Build Options - cl_codeplay_extra_build_options</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_kernel_exec_info.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Kernel Exec Info - cl_codeplay_kernel_exec_info</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_performance_counters.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Performance Counters - cl_codeplay_performance_counters</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_soft_math.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Soft Math - cl_codeplay_soft_math</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_codeplay_wfv.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Whole Function Vectorization - cl_codeplay_wfv</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_intel_unified_shared_memory.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>USM - cl_intel_unified_shared_memory</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/extension/cl_intel_required_subgroup_size.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Required subgroup sizes for kernels  - cl_intel_required_subgroup_size</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/external-extensions.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>OpenCL External Extensions</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/icd-loader.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>OpenCL ICD Loader</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/intercept.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>OpenCL Intercept Layer</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/tools.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Tools</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/test.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Tests</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/cl/test/unitcl.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>UnitCL</a><ol></ol></li></ol></li></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/source/vk.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Vulkan</a><ol></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Modules</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/builtins.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Builtins</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/builtins/abacus.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Abacus</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/builtins/libimg.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Image Library</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>ComputeMux</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/changes.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Change Log</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/compiler.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Compiler</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/cmake.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>CMake</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/bumping-the-spec.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Bumping the Specification Version</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/host.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Host CPU</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/targets/host/extension/cl_codeplay_host_builtins.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>cl_codeplay_host_builtins</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/targets/host/extension/cl_codeplay_set_threads.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>cl_codeplay_set_threads</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/targets/host/lit.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Host lit test suite</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/mux/targets/host/debug.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Host Debug Features</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/riscv.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>RISC-V</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Compiler</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler/overview.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Overview</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler/utils.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Compiler Utilities</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler/tools.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Tools</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler/tools/muxc.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>muxc</a><ol></ol></li></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/loader.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>ELF loader</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/vecz.html"><div class="icon"><span class="icon material-icons">subdirectory_arrow_right</span></div>Vecz</a><ol><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/vecz/vecz.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Vecz Documentation</a><ol></ol></li></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/spirv-ll.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>spirv-ll</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/debug.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Debug Module</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/cargo.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Cargo Module</a><ol></ol></li><li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/metadata.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Metadata API</a><ol></ol></li></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/cmake.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>CMake Development</a><ol></ol></li>               <li class=""><a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/scripts.html"><div class="icon"><span class="icon material-icons">arrow_forward</span></div>Scripts</a><ol></ol></li>           </ol>
       </div>
    </div>
    <!-- Core Content -->
    <div>
        <!-- File Content -->
        <div id="content-container" class="nav-padding">
            <article class="file-content-container">
                <header>
                    <!-- Deprecated Notice -->

                    <div class="title">
                        <a class="header-link" href="#adding-a-custom-builtins-extension">
                            <h1>Adding A Custom Builtins Extension</h1>
                        </a>
                        <div>
                            <a href="#rate" title="Rate this guide">
                                <i class="material-icons">thumb_up</i>
                            </a>

                            <a target="_blank" href="https://github.com/codeplaysoftware/oneapi-construction-kit/blob/main/doc/tutorials/adding-a-custom-builtins-extension.rst" rel="noopener" title="Contribute to this guide">
                                <i class="material-icons">edit</i>
                            </a>

                            <a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/custom-lowering-work-item-builtins" title="Goto the next guide">
                                <i class="material-icons">arrow_forward_ios</i>
                            </a>
                        </div>
                    </div>

                </header>

                <div class="formatted-text">
                    <a id="top"></a>
                    <html><body><div class="document">
<div>
<div class="section" id="adding-a-custom-builtins-extension">

<p>This tutorial is intended to be based on the target created in the
<a class="reference internal" href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/overview/tutorials/creating-a-new-mux-target/running-new-target-script.html#running-the-create-target-py-script"><span class="std std-ref">create new target tutorial</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the user does not want to do the whole tutorial the <code class="docutils literal notranslate">json</code> file
<code class="docutils literal notranslate">refsi_with_wrapper.json</code> can be used in the target creation. Also if the user
wishes to see the result of this tutorial, “;clmul” can be added to the <code class="docutils literal notranslate">feature</code>
<code class="docutils literal notranslate">json</code> entry.</p>
</div>
<p>It is common that a target’s hardware has specialized instructions which
accelerate operations suited to the platform and its intended domain.</p>
<p>Often, these instructions can be successfully matched from user code
automatically, through the compiler backend identifying and optimizing
sequences of basic operations.</p>
<p>Occasionally, these instructions are so specialized that compilers are unable
to match them automatically. In this situation it is common that vendors
provide <em>builtin functions</em> to users for use in their programs. These builtins
are then caught and matched to specialized instructions by compilers.</p>
<p>This tutorial shows an example of such a scenario using RISC-V’s <a class="reference external" href="https://github.com/riscv/riscv-bitmanip/releases/tag/1.0.0">carry-less
multiplication (Zbc) extension</a>. It will expose
the <em>carry-less multiplication</em> (<code class="docutils literal notranslate">clmul*</code>) instructions to users via builtin
functions for use in OpenCL programs.</p>
<div class="section" id="registering-a-new-compiler-extension">
<a class="header-link" href="#registering-a-new-compiler-extension"><h2 id="registering-a-new-compiler-extension">Registering A New Compiler Extension</h2><span class="material-icons">link</span></a>
<p>Registering a new compiler extension in ComputeMux requires the following files:</p>
<pre><code class="language-default">compiler/refsi_tutorial/extension/riscv_clmul/
├─ CMakeLists.txt
├─ include/
│  ├─ extension/
│  │  ├─ riscv_clmul.h
│  │  ├─ builtins.h
├─ source/
│  ├─ riscv_clmul.cpp
</code>
</pre>
<p>Note that this requires the new directory <cite>extension</cite> to have a simple
<cite>CMakeLists.txt</cite> as follows:</p>
<pre><code class="language-cmake">add_subdirectory(riscv_clmul)
</code>
</pre>
<p>The <cite>extension</cite> subdirectory has to be added to
<code class="docutils literal notranslate">compiler/refsi_tutorial/CMakeLists.txt</code> before <code class="docutils literal notranslate">set(REFSI_TUTORIAL_SOURCES</code>:</p>
<pre><code class="language-cmake">add_subdirectory(extension)

# add before this point
set(REFSI_TUTORIAL_SOURCES
</code>
</pre>
<p>The main header and source files provide the OpenCL runtime with knowledge of
the extension when registered:</p>
<p><code class="docutils literal notranslate">riscv_clmul.h</code>:</p>
<pre><code class="language-cpp">#ifndef EXTENSION_RISCV_CLMUL_INCLUDED
#define EXTENSION_RISCV_CLMUL_INCLUDED

#include &lt;extension/extension.h&gt;

namespace extension {

class riscv_clmul final : public extension {
 public:
  riscv_clmul();
};

}  // namespace extension

#endif  // EXTENSION_RISCV_CLMUL_INCLUDED
</code>
</pre>
<p><code class="docutils literal notranslate">riscv_clmul.cpp</code>:</p>
<pre><code class="language-cpp">#include &lt;extension/riscv_clmul.h&gt;

extension::riscv_clmul::riscv_clmul()
    : extension("cl_riscv_clmul",
                usage_category::DEVICE CA_CL_EXT_VERSION(1, 0, 0)) {}
</code>
</pre>
<p>The CMake code is used to register a compiler extension with these source files
and register a <em>force-include</em> header file which is implicitly included in all
OpenCL programs when the extension is enabled.</p>
<p><code class="docutils literal notranslate">CMakeLists.txt</code>:</p>
<pre><code class="language-cmake">add_ca_cl_compiler_extension(riscv-clmul
  EXTENSIONS riscv_clmul
  INCLUDE_DIRS ${CMAKE_CURRENT_SOURCE_DIR}/include
  SOURCES
  ${CMAKE_CURRENT_SOURCE_DIR}/include/extension/riscv_clmul.h
  ${CMAKE_CURRENT_SOURCE_DIR}/source/riscv_clmul.cpp)

add_ca_force_header(PREFIX "riscv_clmul"
  DEVICE_NAME "${CA_REFSI_TUTORIAL_DEVICE}"
  PATH "${CMAKE_CURRENT_SOURCE_DIR}/include/extension/builtins.h")
</code>
</pre>
<p>The force-include header itself provides declarations of the builtin functions
to expose to users. This tutorial covers adding three builtins which map 1:1
with their corresponding RISC-V instructions, assuming a 64-bit RISC-V platform
(i.e., mapping the 64-bit <code class="docutils literal notranslate">long</code> directly to the native 64-bit register
length without type promotion).</p>
<p><code class="docutils literal notranslate">builtins.h</code>:</p>
<pre><code class="language-c">// Produce the lower half of the 128-bit carry-less product
__attribute__((overloadable)) long clmul(long, long);

// Produce the upper half of the 128-bit carry-less product
__attribute__((overloadable)) long clmulh(long, long);

// Produces bits 126-63 of the 128-bit carry-less product
__attribute__((overloadable)) long clmulr(long, long);
</code>
</pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Builtins must be given the <a class="reference external" href="https://releases.llvm.org/16.0.0/tools/clang/docs/AttributeReference.html#overloadable">overloadable attribute</a>
as OpenCL functions are internally required to be mangled according to their
type signatures.</p>
</div>
<p>With the extension registered, it is now possible for users to use these
builtins in programs via the implicitly-included header:</p>
<pre><code class="language-c">kernel void do_clmul(global long *a, global long *b, global long *z) {
  size_t id = get_global_id(0);
  z[id] = clmul(a[id], b[id]);
}
</code>
</pre>
<p>However, the builtins have been provided only as <em>declarations</em> so the compiler
is required to provide <em>definitions</em> for the builtins. Without this step, the
program fails to build as it contains unresolved symbols. The next step is to
modify the compiler to translate the builtin functions to <em>LLVM intrinsic
functions</em> which finish the implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Builtins can be given default software implementations, with the compiler
optimizing to more optimal forms given certain conditions, but that is not
within the scope of the tutorial.</p>
</div>
</div>
<div class="section" id="builtin-replacement">
<a class="header-link" href="#builtin-replacement"><h2 id="builtin-replacement">Builtin Replacement</h2><span class="material-icons">link</span></a>
<p>With the <code class="docutils literal notranslate">clmul*</code> builtins registered via the extension and successfully
entering the LLVM IR module via the compiler frontend, the next step is to
ensure that the builtins are lowered to the appropriate instructions.</p>
<p>This tutorial lowers builtins to RISC-V instructions via <em>LLVM intrinsics</em> as
the open-source LLVM 13+ compiler provides intrinsics which map 1:1 with
<code class="docutils literal notranslate">clmul*</code> instructions. The task, therefore, is to replace calls to <code class="docutils literal notranslate">clmul*</code>
builtin functions in LLVM IR with calls to <code class="docutils literal notranslate">llvm.riscv.clmul*</code> intrinsic
functions.</p>
<p>ComputeMux makes this task straightforward; targets can hook in custom logic to
replace builtin functions with more optimal sequences of LLVM IR.</p>
<p>The <a class="reference internal" href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/modules/compiler/utils.html#optimalbuiltinreplacementpass"><span class="std std-ref">OptimalBuiltinReplacementPass</span></a> is a utility pass that
runs over a module, identifying call instructions and replacing them with new
IR sequences. This pass will run by default in the <code class="docutils literal notranslate">refsi_tutorial</code>.
Alternatively the pass can be run at any point by targets with their own
customized pass pipelines. Part of the information it uses for the replacements
is defined by a <code class="docutils literal notranslate">BuiltinInfo</code> class.</p>
<p>The pass needs more information to replace <code class="docutils literal notranslate">clmul*</code> instructions. This can be
done by creating a custom inherited class from <code class="docutils literal notranslate">CLBuiltinInfo</code>. <code class="docutils literal notranslate">CLBuiltinInfo</code>
is a class that encapsulates information and transformations concerning
compiler OpenCL builtin functions.</p>
<p>First we define the class, which needs to define two methods, <code class="docutils literal notranslate">analyzeBuiltin</code>
and <code class="docutils literal notranslate">emitBuiltinInline</code> as follows after the headers in <code class="docutils literal notranslate">module.cpp</code>:</p>
<pre><code class="language-cpp">#include &lt;llvm/IR/IntrinsicsRISCV.h&gt;
#include &lt;compiler/utils/mangling.h&gt;

namespace refsi_tutorial {
  class CLTargetBuiltinInfo : public compiler::utils::CLBuiltinInfo {
  public:
    // Will be filled out by each example
    CLTargetBuiltinInfo(std::unique_ptr&lt;compiler::utils::CLBuiltinLoader&gt; L)
        : compiler::utils::CLBuiltinInfo(std::move(L)) {}
    compiler::utils::Builtin analyzeBuiltin(
        llvm::Function const &amp;Builtin) const override {
    }
    llvm::Value *emitBuiltinInline(
        llvm::Function *Builtin, llvm::IRBuilder&lt;&gt; &amp;B,
        llvm::ArrayRef&lt;llvm::Value *&gt; Args) override {
    }
  };
}
</code>
</pre>
<p>We will fill in the bodies of these function later in the tutorial.</p>
<p>Next we need to update <code class="docutils literal notranslate">createPassMachinery</code> to register our
<code class="docutils literal notranslate">CLTargetBuiltinInfo</code> rather than the default one. This is done via setting a
callback for the <code class="docutils literal notranslate">PassMachinery</code> class which is used to register an analysis pass
which uses a <code class="docutils literal notranslate">BuiltinInfo</code> class as a basis.</p>
<p>In <code class="docutils literal notranslate">createPassMachinery</code> we replace the lines:</p>
<pre><code class="language-cpp">auto Callback = [Builtins](const llvm::Module &amp;) {
  return compiler::utils::BuiltinInfo(utils::createSimpleCLBuiltinInfo(Builtins));
};
</code>
</pre>
<p>with</p>
<pre><code class="language-cpp">auto Callback = [Builtins](const llvm::Module &amp;) {
  return compiler::utils::BuiltinInfo(createSimpleTargetCLBuiltinInfo(Builtins));
};
</code>
</pre>
<p>This requires <code class="docutils literal notranslate">createSimpleTargetCLBuiltinInfo</code> to be implemented. This
calls <code class="docutils literal notranslate">std::make_unique</code> to create a unique pointer to a newly created
BILangInfoConcept templated with the new class and passes it a builtin loader.
This can be written as follows:</p>
<pre><code class="language-cpp">std::unique_ptr&lt;compiler::utils::BILangInfoConcept&gt; createSimpleTargetCLBuiltinInfo(
    llvm::Module *Builtins) {
  return std::make_unique&lt;CLTargetBuiltinInfo&gt;(
      std::make_unique&lt;compiler::utils::SimpleCLBuiltinLoader&gt;(Builtins));
</code>
</pre>
<p>At this point everything is plumbed in, but the class will do nothing different
to <code class="docutils literal notranslate">CLBuiltinInfo</code>. There are two parts to this. Firstly we need to implement
the <code class="docutils literal notranslate">analyzeBuiltin</code>. This has to return property information about the
builtin. In this case we want to say that it can be emitted inline. We also set
the no <code class="docutils literal notranslate">side effects</code> property to assist optimization. This also demangles the
names of the builtins to match. Note that if we are not declaring any additional
BuiltinID values, we can use <code class="docutils literal notranslate">eBuiltinUnknown</code>. Replace <code class="docutils literal notranslate">analyzeBuiltin</code>
method with the following:</p>
<pre><code class="language-cpp">compiler::utils::NameMangler mangler(&amp;Builtin.getParent()-&gt;getContext());
llvm::StringRef BaseName = mangler.demangleName(Builtin.getName());

if ((BaseName == "clmul") || (BaseName == "clmulh") ||
    (BaseName == "clmulr")) {
  unsigned Properties = compiler::utils::eBuiltinPropertyCanEmitInline |
                        compiler::utils::eBuiltinPropertyNoSideEffects;
  return (compiler::utils::BuiltinProperties)Properties;
  return compiler::utils::Builtin{
      Builtin, compiler::utils::eBuiltinUnknown,
      (compiler::utils::BuiltinProperties)Properties};
}
compiler::utils::CLBuiltinInfo::analyzeBuiltin(Builtin);
</code>
</pre>
<p>With this in place we update <code class="docutils literal notranslate">emitBuiltinInline</code> by identifying calls to
<code class="docutils literal notranslate">clmul</code>, <code class="docutils literal notranslate">clmulh</code> and <code class="docutils literal notranslate">clmulr</code> and replaces them with the equivalent LLVM
intrinsic.</p>
<pre><code class="language-cpp">if (Builtin) {
  compiler::utils::NameMangler mangler(&amp;Builtin-&gt;getParent()-&gt;getContext());
  llvm::StringRef BaseName = mangler.demangleName(Builtin-&gt;getName());
  if (BaseName == "clmul") {
    return B.CreateIntrinsic(llvm::Intrinsic::riscv_clmul,
                            Builtin-&gt;getReturnType(), {Args[0], Args[1]});
  } else if (BaseName == "clmulh") {
    return B.CreateIntrinsic(llvm::Intrinsic::riscv_clmulh,
                            Builtin-&gt;getReturnType(), {Args[0], Args[1]});
  } else if (BaseName == "clmulr") {
    return B.CreateIntrinsic(llvm::Intrinsic::riscv_clmulr,
                            Builtin-&gt;getReturnType(), {Args[0], Args[1]});
  }
}
return compiler::utils::CLBuiltinInfo::emitBuiltinInline(Builtin, B, Args);
</code>
</pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For simplicity, no validation or type checking is performed here.</p>
</div>
</div>
<div class="section" id="final-result">
<a class="header-link" href="#final-result"><h2 id="final-result">Final Result</h2><span class="material-icons">link</span></a>
<p>With the above step completed, users can compile OpenCL programs using
<code class="docutils literal notranslate">clmul*</code> builtins that are optimally mapped directly to RISC-V instructions.
This can be done with the standalone compiler <cite>clc</cite> (which can be built with
<code class="docutils literal notranslate">ninja clc</code>).</p>
<p><code class="docutils literal notranslate">clmul.cl</code>:</p>
<pre><code class="language-c">kernel void do_clmul(global long *a, global long *b, global long *z) {
  size_t id = get_global_id(0);
  z[id] = clmul(a[id], b[id]);
}
</code>
</pre>
<pre><code class="language-sh">clc --strip-binary-header -o clmul.o clmul.cl -cl-wfv=never

llvm-objdump --disassemble --triple=riscv64 --mattr="v,c,zbc" clmul.o | grep clmul

0000000000010000 &lt;do_clmul&gt;:
   1003c: 33 96 c6 0a   clmul   a3, a5, a3
</code>
</pre>
</div>
<div class="section" id="lit-testing">
<a class="header-link" href="#lit-testing"><h2 id="lit-testing">Lit Testing</h2><span class="material-icons">link</span></a>
<p>Finally this can also be tested using a lit test, which is a common way of
testing passes in LLVM. The tool <code class="docutils literal notranslate">muxc</code> can be used for this purpose in a similar
way to how the LLVM tool <code class="docutils literal notranslate">opt</code> can be used. Create the following file
<code class="docutils literal notranslate">compiler/refsi_tutorial/test/clmul_replace.ll</code>:</p>
<pre><code class="language-default">; RUN: %muxc --device "RefSi M1 Tutorial" %s --passes "require&lt;builtin-info&gt;,optimal-builtin-replace,verify" -S | FileCheck %s

target datalayout = "e-m:e-p:64:64-i64:64-i128:128-n64-S128"
target triple = "riscv64-unknown-unknown-elf"

; CHECK:   call i64 @llvm.riscv.clmul.i64
; CHECK:   call i64 @llvm.riscv.clmulh.i64
; CHECK:   call i64 @llvm.riscv.clmulr.i64

; Function Attrs: norecurse nounwind
define spir_kernel void @do_clmul(ptr addrspace(1) %a, ptr addrspace(1) %b, ptr addrspace(1) %z) {
entry:
  %0 = load i64, ptr addrspace(1) %a
  %1 = load i64, ptr addrspace(1) %b
  %call = tail call spir_func i64 @_Z5clmulll(i64 %0, i64 %1)
  %call4 = tail call spir_func i64 @_Z6clmulhll(i64 %0, i64 %1)
  %add = add nsw i64 %call4, %call
  %call7 = tail call spir_func i64 @_Z6clmulrll(i64 %0, i64 %1)
  %add8 = add nsw i64 %add, %call7
  store i64 %add8, ptr addrspace(1) %z
  ret void
}

declare spir_func i64 @_Z5clmulll(i64, i64)

declare spir_func i64 @_Z6clmulhll(i64, i64)

declare spir_func i64 @_Z6clmulrll(i64, i64)
</code>
</pre>
<p><code class="docutils literal notranslate">muxc</code> is used here to run the the <code class="docutils literal notranslate">builtin-info</code> analysis pass and the
<code class="docutils literal notranslate">optimal-builtin-replace</code> pass on the input IR. This results in the output of the
intrinsics <code class="docutils literal notranslate">llvm.riscv.clmul*</code>.</p>
<p>All of the lit tests for the <code class="docutils literal notranslate">refsi-tutorial</code> target can be run with building the
<code class="docutils literal notranslate">check-ock-refsi-tutorial-lit</code> target. If you use the create script for
building new targets the target name will be used instead of
<code class="docutils literal notranslate">refsi-tutorial</code>.</p>
</div>
</div>
</div>
</div></body>
<!-- Mirrored from 127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 22 Sep 2025 18:52:46 GMT -->
</html>
                    <a id="bottom"></a>
                </div>

                <!-- Separator -->
                <div class="separator"></div>

                <!-- Rate -->
                <div id="rate" class="rate collapsed">
                    <div>
                        Rate this Guide
                    </div>
                    <form action="https://formspree.io/f/xzbypbvl" method="post">
                        <input type="hidden" name="subject" value="Guide Feedback" />
                        <input type="hidden" name="product" value="oneAPI" />
                        <input type="hidden" name="variant" value="Construction Kit" />
                        <input type="hidden" name="guide" value="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/adding-a-custom-builtins-extension" />

                        <div class="up" title="Thumb up this guide">
                           <i class="material-icons">thumb_up</i>
                       </div>
                        <div class="down" title="Thumb down this guide">
                            <i class="material-icons">thumb_down</i>
                        </div>
                        <div>
                            <input type="text" name="message"
                                   required="required"
                                   minlength="3"
                                   maxlength="1000"
                                   placeholder="How can we improve this guide? (press enter to send)" />
                        </div>
                    </form>
                </div>

                <!-- Separator -->
                <div class="separator"></div>

                <!-- Navigator -->
                <div id="navigator">
                    <div>
                        <a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials#bottom"
                            >
                            <div>
                                <i class="material-icons">navigate_before</i>
                            </div>
                            <div>
                                <h1>Tutorials</h1>
                            </div>
                        </a>
                    </div>
                    <div>
                        <a href="http://127.0.0.1/products/oneapi/construction-kit/4.0.0/guides/tutorials/custom-lowering-work-item-builtins"
                            >
                            <div>
                                <h1>Custom Lowering Work-Item Builtins</h1>
                            </div>
                            <div>
                                <i class="material-icons">navigate_next</i>
                            </div>
                        </a>
                    </div>
                </div>
            </article>

            <!-- Separator -->
            <div class="separator"></div>

            <!-- Footer Target -->
            <div id="footer-target"></div>
        </div>

        <!-- File Jump List -->
        <div id="jump-list-container" class="sticky styled-scroller">
            <div class="nav-padding">
                <div class="jump-list-container">
                    <h1 class="file-container-title">
                        <span class="material-icons">assignment</span>Jump to Section
                    </h1>
                    <ol class="in-page-jump-list">
                        <li class="heading-1"><a href="#adding-a-custom-builtins-extension">Adding A Custom Builtins Extension</a></li>
                        <li class="heading-2"><a href="#registering-a-new-compiler-extension">Registering A New Compiler Extension</a></li>
                        <li class="heading-2"><a href="#builtin-replacement">Builtin Replacement</a></li>
                        <li class="heading-2"><a href="#final-result">Final Result</a></li>
                        <li class="heading-2"><a href="#lit-testing">Lit Testing</a></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Handle layout resizing here to avoid jumping -->
<script nonce="583c21e1dde1d4e0fa5ee48835bf8bbe">
    const resizerCookie = getCookie('CDPRESIZER');
    if (resizerCookie) {
        const cookieValue = JSON.parse(resizerCookie);

        for (let [key, value] of Object.entries(cookieValue)) {
            if (value === null || value === undefined) {
                continue;
            }

            key = atob(key);
            $(':root')[0].style.setProperty('--' + key, value + 'px');
        }
    }
</script>

</main>

<!-- Product Selector-->
<div id="productSelectorDialog" class="popupDialog">
    <div class="side-by-side-panel panel">
        <div id="products">
            <div>
                <h1>Select a Product</h1>
            </div>
            <ul>
                <li>
                    <a class="productSelection oneapi" data-product="oneapi">
                        oneAPI
                    </a>
                </li>
            </ul>
        </div>
        <div id="product-selection">
            <div id="no-product">
                Please select a product
            </div>
            <div id="product">
                <div id="product-oneapi" class="product-view">
                    <h1>

                        oneAPI
                    </h1>
                    <p>oneAPI is a cross-industry, open, standards-based unified programming model that delivers a common developer experience across accelerator architecture - for faster application performance, more productivity, and greater innovation.</p>
                    <ul id="variants">
                        <li>
                            <a href="http://127.0.0.1/products/oneapi/construction-kit/">
                                <div>
                                    Construction Kit
                                </div>
                                <div>
                                    <i class="material-icons">arrow_right</i>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="http://127.0.0.1/products/oneapi/amd/">
                                <div>
                                    for AMD GPU
                                </div>
                                <div>
                                    <i class="material-icons">arrow_right</i>
                                </div>
                            </a>
                        </li>
                        <li>
                            <a href="http://127.0.0.1/products/oneapi/nvidia/">
                                <div>
                                    for NVIDIA® GPUs
                                </div>
                                <div>
                                    <i class="material-icons">arrow_right</i>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Color Scheme Selector-->
<div id="colorSchemeDialog" class="popupDialog">
    <div>
        <div class="selectDarkMode">
            <div>
                <img src="http://127.0.0.1/assets/img/darkmode.png" alt="Dark Mode" />
            </div>
            <div>
                <i class="material-icons">brightness_2</i>
                <h1>Dark Mode</h1>
                <p>Light text on a dark background.</p>
            </div>
        </div>
        <div class="selectLightMode">
            <div>
                <img src="http://127.0.0.1/assets/img/lightmode.png" alt="Light Mode" />
            </div>
            <div>
                <i class="material-icons">lightbulb_outline</i>
                <h1>Light Mode</h1>
                <p>Dark text on a light background.</p>
            </div>
        </div>
    </div>
</div>

<!-- Site Selector -->
<div id="siteSelectorDialog" class="popupDialog">
    <div class="panel" id="profile-panel">
        <header>
            <div>
                <i class="material-icons">public</i>
            </div>
            <div>
                <h1>Also,</h1>
                <h2>part of our network</h2>
            </div>
        </header>
        <ul>
            <li>
                <a href="https://www.codeplay.com/" target="_blank" rel="nofollow noopener noreferrer">
                    <h1>Codeplay.com</h1>
                    <p>Find out about Codeplay, the latest company news and blog posts.</p>
                </a>
            </li>
            <li>
                <a href="https://www.sycl.tech/" target="_blank" rel="nofollow noopener noreferrer">
                    <h1>SYCL.tech</h1>
                    <p>Find out about the latest SYCL news, videos and projects.</p>
                </a>
            </li>
            <li class="selected">
                <a>
                    <img src="http://127.0.0.1/assets/img/you-are-here.png" alt="You Are Here Logo" />
                    <h1>Codeplay Developer</h1>
                    <p>Get the latest documentation and release packages for ComputeCpp and ComputeSuite</p>
                </a>
            </li>
            <li>
                <a href="https://github.com/codeplaysoftware" target="_blank" rel="nofollow noopener noreferrer">
                    <h1>Codeplay Open Source</h1>
                    <p>Browse our open source projects and frameworks on GitHub.</p>
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Footer section -->
<footer class="section-padding">
    <div class="content-wrapper">
        <div>
            <h1>&copy; Codeplay Software Ltd</h1>
            <div id="copyright"></div>
        </div>
        <div>
            <ul>
                <li><a href="https://codeplay.com/" target="_blank" rel="noopener">
                    Visit codeplay.com</a></li>
                <li><a href="https://codeplay.com/company/privacy/" target="_blank" rel="noopener">
                    View Our Privacy Policy</a></li>
                <li><a href="http://127.0.0.1/cookies/">
                    Read Our Cookie Policy</a></li>
            </ul>
        </div>
    </div>
</footer>

</body>
</html>